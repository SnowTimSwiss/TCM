<!DOCTYPE html>
<html lang="de">
<head>
    <!-- Meta-Tags für korrekte Zeichenkodierung und Responsive Design -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Admin - Shop Verwaltung</title>
    
    <style>
        /* Grundlegende Seitengestaltung */
        body { 
            margin:0; 
            font-family:sans-serif; 
            background:#0f1720; /* Dunkler Hintergrund */
            color:#e6eef6; /* Helle Textfarbe */
            display:flex; 
            flex-direction: column;
            align-items:center; 
            min-height:100vh;
            padding:20px;
        }
        
        /* Karten-Design für Inhaltsblöcke */
        .card { 
            background:#111827; 
            padding:30px 40px; 
            border-radius:12px; 
            width:90%;
            max-width:800px;
            box-shadow:0 6px 18px rgba(0,0,0,0.7); 
            margin-bottom:20px;
        }
        
        /* Überschrift */
        h1 { 
            text-align:center; 
            margin-bottom:20px; 
            font-size:1.4rem; 
            color:#60a5fa; /* Akzentfarbe Blau */
        }
        
        /* Eingabefelder */
        input { 
            width:100%; 
            padding:10px; 
            margin:6px 0; 
            border:none; 
            border-radius:6px; 
            background:#07101a; 
            color:#e6eef6; 
            box-sizing:border-box;
        }
        
        /* Basis-Button-Stil */
        button { 
            padding:10px; 
            border:none; 
            border-radius:6px; 
            background:#60a5fa; 
            color:#042035; 
            font-weight:bold; 
            cursor:pointer; 
            margin-top:8px; 
            transition:0.2s;
        }
        
        /* Hover-Effekt für Buttons */
        button:hover { 
            background:#3b82f6; 
        }
        
        /* Gefahren-Button (rot) */
        .danger { background:#dc2626; }
        .danger:hover { background:#b91c1c; }
        
        /* Erfolgs-Button (grün) */
        .success { background:#059669; }
        .success:hover { background:#047857; }
        
        /* Statusmeldungs-Container */
        #admin-status { 
            margin-top:15px; 
            font-size:0.9rem; 
            white-space:pre-wrap; 
            background:#07101a; 
            padding:10px; 
            border-radius:6px; 
            display:none; 
        }
        
        /* Erfolgs-Status (grün) */
        .status-success { color:#34d399; display:block !important; }
        
        /* Fehler-Status (rot) */
        .status-error { color:#fca5a5; display:block !important; }
        
        /* Grid-Layout für Produktliste */
        .products-grid {
            display:grid;
            grid-template-columns:repeat(auto-fill, minmax(250px, 1fr));
            gap:16px;
            margin-top:20px;
        }
        
        /* Einzelne Produktkarte */
        .product-card {
            background:#1a2435;
            padding:16px;
            border-radius:8px;
            border:1px solid #2d3748;
        }
        
        /* Produktname */
        .product-card h3 {
            margin:0 0 8px 0;
            color:#60a5fa;
            font-size:1.1rem;
        }
        
        /* Produktdetails */
        .product-card p {
            margin:4px 0;
            font-size:0.9rem;
            color:#cbd5e1;
        }
        
        /* Button-Container in Produktkarte */
        .product-actions {
            margin-top:12px;
            display:flex;
            gap:8px;
            flex-wrap:wrap;
        }
        
        /* Buttons in Produktkarte */
        .product-actions button {
            flex:1;
            margin:0;
            padding:6px 8px;
            font-size:0.8rem;
        }
        
        /* Lagerbestandskontrolle mit Input und Button */
        .stock-control {
            display:flex;
            align-items:center;
            gap:8px;
            margin-top:8px;
        }
        
        /* Eingabefeld für Lagerbestand */
        .stock-control input {
            width:60px;
            margin:0;
        }
        
        /* Zwei-spaltige Formularzeile */
        .form-row {
            display:grid;
            grid-template-columns:1fr 1fr;
            gap:12px;
        }

        /* --- Bestellungen Styling --- */
        
        /* Bestellungskarte */
        .order-card {
            background: #1a2435;
            border: 1px solid #2d3748;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        /* Kopfbereich der Bestellung mit ID und Datum */
        .order-header {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #374151;
            padding-bottom: 10px;
            margin-bottom: 10px;
            color: #60a5fa;
            font-weight: bold;
        }
        
        /* Kunden- und Adressdetails */
        .order-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
        
        /* Tabelle für Bestellpositionen */
        .order-items-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        /* Tabellenkopf */
        .order-items-table th {
            text-align: left;
            color: #94a3b8;
            border-bottom: 1px solid #374151;
            padding: 5px;
        }
        
        /* Tabellenzellen */
        .order-items-table td {
            padding: 5px;
            border-bottom: 1px solid #1f2937;
            color: #cbd5e1;
        }
        
        /* Adress-Box */
        .address-box {
            background: #111827;
            padding: 10px;
            border-radius: 4px;
            color: #e2e8f0;
        }
    </style>
</head>

<body>
    <!-- Karte für neues Produkt -->
    <div class="card">
        <h1>Neues Produkt hinzufügen</h1>

        <!-- Eingabeformular für Produktdaten -->
        <div class="form-row">
            <input id="p-name" placeholder="Produktname" />
            <input id="p-price" placeholder="Preis in Euro (z.B. 12.99)" />
        </div>
        <input id="p-desc" placeholder="Beschreibung" />
        <div class="form-row">
            <input id="p-stock" placeholder="Lagerbestand" type="number" />
            <button id="btn-add" style="width:100%">Produkt hinzufügen</button>
        </div>

        <!-- Bereich für Statusmeldungen -->
        <div id="admin-status"></div>
    </div>

    <!-- Karte für vorhandene Produkte -->
    <div class="card">
        <h1>Vorhandene Produkte verwalten</h1>
        <div id="products-list" class="products-grid">
            <!-- Hier werden dynamisch Produkte eingefügt -->
        </div>
    </div>

    <!-- Karte für Bestellungen -->
    <div class="card">
        <h1>Eingegangene Bestellungen</h1>
        <!-- Button zum Aktualisieren der Bestellliste -->
        <button onclick="loadOrders()" style="margin-bottom: 20px;">Aktualisieren</button>
        <div id="orders-list">
            <!-- Platzhalter während des Ladens -->
            <p style="text-align:center; color:#888;">Lade Bestellungen...</p>
        </div>
    </div>

    <!-- Externe JavaScript-Datei für API-Funktionen -->
    <script src="/static/js/api.js"></script>
    
    <script>
        // ============================================
        // 1. PRODUKTVERWALTUNG
        // ============================================

        /**
         * Lädt alle Produkte vom Server und zeigt sie an
         */
        async function loadProducts() {
            try {
                // API-Aufruf zur Abfrage aller Produkte
                const data = await api('/api/products');
                const container = document.getElementById('products-list');
                container.innerHTML = ''; // Container leeren

                // Für jedes Produkt eine Karte erstellen
                data.products.forEach(product => {
                    const productEl = document.createElement('div');
                    productEl.className = 'product-card';
                    
                    // HTML-Struktur für Produktkarte
                    productEl.innerHTML = `
                        <h3>${product.name}</h3>
                        <p>${product.description || 'Keine Beschreibung'}</p>
                        <p><strong>Preis:</strong> ${(product.price_cents / 100).toFixed(2)} €</p>
                        <p><strong>Lagerbestand:</strong> ${product.stock}</p>
                        <div class="stock-control">
                            <input type="number" id="stock-${product.id}" placeholder="Menge" min="1" value="1" />
                            <button class="success" onclick="addStock(${product.id})">+ Lager</button>
                        </div>
                        <div class="product-actions">
                            <button class="danger" onclick="deleteProduct(${product.id})">Löschen</button>
                        </div>
                    `;
                    container.appendChild(productEl);
                });
            } catch (error) {
                // Fehlerbehandlung
                showStatus('Fehler beim Laden der Produkte: ' + (error.error || error), 'error');
            }
        }

        /**
         * Event-Listener für "Produkt hinzufügen" Button
         */
        document.getElementById('btn-add').onclick = async () => {
            // Werte aus den Eingabefeldern holen
            const name = document.getElementById('p-name').value.trim();
            const desc = document.getElementById('p-desc').value.trim();
            const price = parseFloat(document.getElementById('p-price').value || "0");
            const stock = parseInt(document.getElementById('p-stock').value || "0");

            // Validierung der Eingaben
            if (!name || price <= 0 || stock < 0) {
                showStatus('Bitte fülle alle Felder korrekt aus', 'error');
                return;
            }

            // Preis von Euro in Cent umrechnen
            const price_cents = Math.round(price * 100);

            try {
                // POST-Request zum Anlegen eines neuen Produkts
                const res = await fetch('/api/admin/product', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ name, description: desc, price_cents, stock })
                });

                const result = await res.json();
                
                if (res.ok) {
                    // Erfolgsmeldung und Formular zurücksetzen
                    showStatus('Produkt erfolgreich hinzugefügt!', 'success');
                    document.getElementById('p-name').value = '';
                    document.getElementById('p-desc').value = '';
                    document.getElementById('p-price').value = '';
                    document.getElementById('p-stock').value = '';
                    
                    // Produktliste aktualisieren
                    await loadProducts();
                } else {
                    // Fehler vom Server
                    showStatus('Fehler: ' + (result.error || 'Unbekannter Fehler'), 'error');
                }
            } catch (error) {
                // Netzwerkfehler
                showStatus('Netzwerkfehler: ' + error, 'error');
            }
        };

        /**
         * Erhöht den Lagerbestand eines Produkts
         * @param {number} productId - ID des Produkts
         */
        async function addStock(productId) {
            const stockInput = document.getElementById(`stock-${productId}`);
            const addAmount = parseInt(stockInput.value || "0");
            
            // Validierung
            if (addAmount <= 0) {
                showStatus('Bitte eine gültige Menge eingeben', 'error');
                return;
            }

            try {
                // API-Aufruf zur Bestandsaktualisierung
                await adminUpdateStock(productId, addAmount);
                showStatus(`Lagerbestand um ${addAmount} erhöht!`, 'success');
                stockInput.value = '1'; // Zurücksetzen auf Standardwert
                await loadProducts(); // Liste aktualisieren
            } catch (error) {
                showStatus('Fehler: ' + (error.error || error.message || 'Unbekannter Fehler'), 'error');
            }
        }

        /**
         * Löscht ein Produkt
         * @param {number} productId - ID des zu löschenden Produkts
         */
        async function deleteProduct(productId) {
            // Sicherheitsabfrage
            if (!confirm('Möchtest du dieses Produkt wirklich löschen?')) {
                return;
            }
            
            try {
                // API-Aufruf zum Löschen
                await adminDeleteProduct(productId);
                showStatus('Produkt erfolgreich gelöscht!', 'success');
                await loadProducts(); // Liste aktualisieren
            } catch (error) {
                showStatus('Fehler: ' + (error.error || error.message || 'Unbekannter Fehler'), 'error');
            }
        }

        // ============================================
        // 2. BESTELLVERWALTUNG
        // ============================================

        /**
         * Lädt alle Bestellungen vom Server und zeigt sie an
         */
        async function loadOrders() {
            const container = document.getElementById('orders-list');
            try {
                // API-Aufruf zur Abfrage aller Bestellungen
                const data = await adminGetOrders();
                
                // Prüfen, ob Bestellungen vorhanden sind
                if (!data.orders || data.orders.length === 0) {
                    container.innerHTML = '<p style="text-align:center;">Keine Bestellungen vorhanden.</p>';
                    return;
                }

                container.innerHTML = ''; // Container leeren

                // Für jede Bestellung eine Karte erstellen
                data.orders.forEach(order => {
                    // Datum formatieren
                    const date = new Date(order.created_at).toLocaleString('de-DE');
                    // Gesamtbetrag von Cent in Euro umrechnen
                    const total = (order.total_cents / 100).toFixed(2);

                    // HTML für Bestellpositionen generieren
                    let itemsHtml = '';
                    order.items.forEach(item => {
                        const itemTotal = ((item.price_cents * item.qty) / 100).toFixed(2);
                        const singlePrice = (item.price_cents / 100).toFixed(2);
                        itemsHtml += `
                            <tr>
                                <td>${item.qty}x</td>
                                <td>${item.name || 'Gelöschtes Produkt'}</td>
                                <td>${singlePrice} €</td>
                                <td style="text-align:right;">${itemTotal} €</td>
                            </tr>
                        `;
                    });

                    // Bestellungskarte erstellen
                    const orderEl = document.createElement('div');
                    orderEl.className = 'order-card';
                    orderEl.innerHTML = `
                        <div class="order-header">
                            <span>Bestellung #${order.id}</span>
                            <span>${date}</span>
                        </div>
                        <div class="order-details">
                            <div>
                                <strong>Kunde:</strong><br>
                                ${order.fullname}<br>
                                <small>${order.email}</small>
                            </div>
                            <div class="address-box">
                                <strong>Lieferadresse:</strong><br>
                                ${order.address || '-'}<br>
                                ${order.postalcode || ''} ${order.city || '-'}
                            </div>
                        </div>
                        <table class="order-items-table">
                            <thead>
                                <tr>
                                    <th width="10%">Menge</th>
                                    <th>Artikel</th>
                                    <th width="20%">Einzelpreis</th>
                                    <th width="20%" style="text-align:right;">Gesamt</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHtml}
                                <tr>
                                    <td colspan="3" style="text-align:right; font-weight:bold; padding-top:10px;">Endsumme:</td>
                                    <td style="text-align:right; font-weight:bold; padding-top:10px; color:#60a5fa;">${total} €</td>
                                </tr>
                            </tbody>
                        </table>
                    `;
                    container.appendChild(orderEl);
                });

            } catch (error) {
                // Fehlerbehandlung
                container.innerHTML = '<p style="color:#fca5a5">Fehler beim Laden der Bestellungen.</p>';
                console.error(error);
            }
        }
        
        // ============================================
        // 3. HILFSFUNKTIONEN
        // ============================================

        /**
         * Zeigt eine Statusmeldung an
         * @param {string} message - Anzuzeigende Nachricht
         * @param {string} type - Typ der Meldung ('success' oder 'error')
         */
        function showStatus(message, type) {
            const status = document.getElementById('admin-status');
            status.innerText = message;
            status.className = type === 'success' ? 'status-success' : 'status-error';
            
            // Meldung nach 5 Sekunden ausblenden
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }

        // ============================================
        // 4. INITIALISIERUNG
        // ============================================

        // Beim Laden der Seite Produkte und Bestellungen laden
        loadProducts();
        loadOrders();
    </script>
</body>

<!-- Fußzeile -->
<footer>
    <p style="text-align:center; color:#888; font-size:0.8rem; margin-top:20px;">
        &copy; 2025 TCM / Power innovation Drive - Elektromobile. Alle Rechte vorbehalten.
    </p>
</footer>
</html>
